package governance

import (
	"encoding/hex"
	"math/big"
	"testing"

	"github.com/klaytn/klaytn/accounts/abi/bind"
	"github.com/klaytn/klaytn/accounts/abi/bind/backends"
	"github.com/klaytn/klaytn/blockchain"
	"github.com/klaytn/klaytn/blockchain/types"
	"github.com/klaytn/klaytn/common"
	govcontract "github.com/klaytn/klaytn/contracts/gov"
	regcontract "github.com/klaytn/klaytn/contracts/registry"
	"github.com/klaytn/klaytn/contracts/reward/contract"
	"github.com/klaytn/klaytn/crypto"
	"github.com/klaytn/klaytn/params"
	"github.com/stretchr/testify/require"
)

var abookAddr = common.HexToAddress(contract.AddressBookContractAddress)

var abookOverride, _ = hex.DecodeString("60806040526004361061022b5763ffffffff600080516020614f4383398151915260003504166315575d5a8114610230578063160370b81461027c5780631865c57d1461038657806321ac4ad4146103f657806327e1f7df1461041c578063298b3c611461043d57806332b91e851461046a578063394a144a146104955780633f0628b1146104b6578063407091eb146104da57806341b6945c146105765780634a8c1fb41461058b5780634b6a94cc146105b45780634c5d435c1461063e5780634f97638f1461066257806350a5bb6914610677578063579740db1461068c57806358d65880146106ad5780636abd623d146106d45780637048027514610705578063715b208b1461072657806376674c54146107d4578063778f39cb146107e95780637894c366146107fe578063791b51231461082257806382d67e5a14610843578063832a2aad146108df578063863f5c0a1461090057806387cd9feb146109215780638e6f6b77146109365780639258d7681461094b578063934d1fa41461096f578063afaaf33014610984578063b50060e4146109a5578063b5067706146109ba578063b7563930146109db578063b858dd95146109f0578063c47afb3a14610a05578063c7e9de7514610a1d578063cc11efc014610a41578063cec9246614610a6e578063d267eda514610a83578063da34a0bd14610a98578063de5bbfbc14610afd578063e748357b14610b12578063feb15ca114610b2a578063ffa1ad7414610b3f575b600080fd5b34801561023c57600080fd5b50610251600160a060020a0360043516610b54565b60408051600160a060020a039485168152928416602084015292168183015290519081900360600190f35b34801561028857600080fd5b50610291610c6e565b60408051600160a060020a0380851660608301528316608082015260a080825287519082015286519091829160208084019284019160c08501918b8101910280838360005b838110156102ee5781810151838201526020016102d6565b50505050905001848103835288818151815260200191508051906020019060200280838360005b8381101561032d578181015183820152602001610315565b50505050905001848103825287818151815260200191508051906020019060200280838360005b8381101561036c578181015183820152602001610354565b505050509050019850505050505050505060405180910390f35b34801561039257600080fd5b5061039b610db9565b6040518080602001838152602001828103825284818151815260200191508051906020019060200280838360005b838110156103e15781810151838201526020016103c9565b50505050905001935050505060405180910390f35b34801561040257600080fd5b5061041a600160a060020a0360043516602435610e25565b005b34801561042857600080fd5b5061041a600160a060020a0360043516610f6c565b34801561044957600080fd5b5061041a600160a060020a03600435811690602435811690604435166110fa565b34801561047657600080fd5b5061047f611549565b6040805160ff9092168252519081900360200190f35b3480156104a157600080fd5b5061041a600160a060020a036004351661154e565b3480156104c257600080fd5b5061041a60ff600435166024356044356064356115c7565b3480156104e657600080fd5b506104fe60ff60043516602435604435606435611c0e565b60408051858152908101839052602081016060820183600481111561051f57fe5b60ff168152602001828103825285818151815260200191508051906020019060200280838360005b8381101561055f578181015183820152602001610547565b505050509050019550505050505060405180910390f35b34801561058257600080fd5b5061047f611cbb565b34801561059757600080fd5b506105a0611cc0565b604080519115158252519081900360200190f35b3480156105c057600080fd5b506105c9611cc9565b6040805160208082528351818301528351919283929083019185019080838360005b838110156106035781810151838201526020016105eb565b50505050905090810190601f1680156106305780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561064a57600080fd5b5061041a600160a060020a0360043516602435611d00565b34801561066e57600080fd5b5061041a611ed1565b34801561068357600080fd5b506105a0611f8c565b34801561069857600080fd5b5061041a600160a060020a0360043516611f9a565b3480156106b957600080fd5b506106c2612388565b60408051918252519081900360200190f35b3480156106e057600080fd5b506106e961238d565b60408051600160a060020a039092168252519081900360200190f35b34801561071157600080fd5b5061041a600160a060020a036004351661239c565b34801561073257600080fd5b5061073b612466565b604051808060200180602001838103835285818151815260200191508051906020019060200280838360005b8381101561077f578181015183820152602001610767565b50505050905001838103825284818151815260200191508051906020019060200280838360005b838110156107be5781810151838201526020016107a6565b5050505090500194505050505060405180910390f35b3480156107e057600080fd5b5061047f612755565b3480156107f557600080fd5b506106c261275a565b34801561080a57600080fd5b5061041a60246004803582810192910135903561275f565b34801561082e57600080fd5b5061041a600160a060020a0360043516612aa1565b34801561084f57600080fd5b5061085b600435612b3a565b6040518088600a81111561086b57fe5b60ff16815260208101889052604081018790526060810186905260a08101849052608081019060c0018360048111156108a057fe5b60ff168152602001828103825285818151815260200191508051906020019060200280838360008381101561036c578181015183820152602001610354565b3480156108eb57600080fd5b5061041a600160a060020a0360043516612bf8565b34801561090c57600080fd5b5061041a600160a060020a0360043516612da8565b34801561092d57600080fd5b5061041a612df7565b34801561094257600080fd5b506106c2612e5d565b34801561095757600080fd5b5061041a600160a060020a0360043516602435612e64565b34801561097b57600080fd5b506106c2612f62565b34801561099057600080fd5b5061041a600160a060020a0360043516612f69565b3480156109b157600080fd5b5061047f612fd0565b3480156109c657600080fd5b5061041a600160a060020a0360043516612fd5565b3480156109e757600080fd5b506106c26130f7565b3480156109fc57600080fd5b506106e96130fd565b348015610a1157600080fd5b5061041a60043561310c565b348015610a2957600080fd5b5061041a600160a060020a03600435166024356131b0565b348015610a4d57600080fd5b5061041a600160a060020a0360043581169060243581169060443516613381565b348015610a7a57600080fd5b5061041a613733565b348015610a8f57600080fd5b506106e9613a3e565b348015610aa457600080fd5b50610aad613a4d565b60408051602080825283518183015283519192839290830191858101910280838360005b83811015610ae9578181015183820152602001610ad1565b505050509050019250505060405180910390f35b348015610b0957600080fd5b5061047f613aa7565b348015610b1e57600080fd5b5061041a600435613aac565b348015610b3657600080fd5b5061041a613b6f565b348015610b4b57600080fd5b506106c2613aa7565b600160a060020a038116600081815260086020526040812054600980549293849384939287929184908110610b8557fe5b600091825260209091200154600160a060020a031614610bef576040805160e560020a62461bcd02815260206004820152601360248201527f496e76616c696420434e206e6f64652049442e00000000000000000000000000604482015290519081900360640190fd5b6009805483908110610bfd57fe5b600091825260209091200154600a8054600160a060020a039092169184908110610c2357fe5b600091825260209091200154600b8054600160a060020a039092169185908110610c4957fe5b6000918252602090912001549196509450600160a060020a0316925050509193909250565b60055460065460098054604080516020808402820181019092528281526060958695869560009586959194600a94600b94600160a060020a03918216949116928791830182828015610ce957602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311610ccb575b5050505050945083805480602002602001604051908101604052809291908181526020018280548015610d4557602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311610d27575b5050505050935082805480602002602001604051908101604052809291908181526020018280548015610da157602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311610d83575b50505050509250945094509450945094509091929394565b606060008060015481805480602002602001604051908101604052809291908181526020018280548015610e1657602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311610df8575b50505050509150915091509091565b600082338385600160a060020a0316630f6100726040518163ffffffff16600080516020614f43833981519152028152600401602060405180830381600087803b158015610e7257600080fd5b505af1158015610e86573d6000803e3d6000fd5b505050506040513d6020811015610e9c57600080fd5b505114610ef3576040805160e560020a62461bcd02815260206004820152601460248201527f496e76616c696420506f432076657273696f6e2e000000000000000000000000604482015290519081900360640190fd5b610f0a6006600160a060020a038716866000613e65565b9250610f236006600160a060020a038716866000613f38565b610f2c83614583565b8015610f575750600160008481526003602052604090206006015460ff166004811115610f5557fe5b145b15610f6557610f658361459e565b5050505050565b6000805481908390610f8590600163ffffffff614cb616565b60015460008054600160a060020a0388168252600260205260408220805460ff19169055955093505b600185038410156110615785600160a060020a0316600085815481101515610fd257fe5b600091825260209091200154600160a060020a0316141561105657600080546000198701908110610fff57fe5b60009182526020822001548154600160a060020a0390911691908690811061102357fe5b9060005260206000200160006101000a815481600160a060020a030219169083600160a060020a03160217905550611061565b600190930192610fae565b60008054600019870190811061107357fe5b60009182526020822001805473ffffffffffffffffffffffffffffffffffffffff19169055546110aa90600163ffffffff614cb616565b6110b5600082614da3565b506110be611ed1565b604051600160a060020a038716907f1af6bd3d85a56e7c4a0700756fd2ca3b3b65c266e56c77652c5a346bc256522090600090a2505050505050565b60095460009081101561119a57600160a060020a03841660008181526008602052604090205460098054909190811061112f57fe5b600091825260209091200154600160a060020a0316141561119a576040805160e560020a62461bcd02815260206004820152601960248201527f434e206e6f646520494420616c72656164792065786973742e00000000000000604482015290519081900360640190fd5b83600160a060020a031683600160a060020a031663139d7fed6040518163ffffffff16600080516020614f43833981519152028152600401602060405180830381600087803b1580156111ec57600080fd5b505af1158015611200573d6000803e3d6000fd5b505050506040513d602081101561121657600080fd5b5051600160a060020a031614611276576040805160e560020a62461bcd02815260206004820152601360248201527f496e76616c696420434e206e6f64652049442e00000000000000000000000000604482015290519081900360640190fd5b81600160a060020a031683600160a060020a0316638cf57cb96040518163ffffffff16600080516020614f43833981519152028152600401602060405180830381600087803b1580156112c857600080fd5b505af11580156112dc573d6000803e3d6000fd5b505050506040513d60208110156112f257600080fd5b5051600160a060020a031614611352576040805160e560020a62461bcd02815260206004820152601a60248201527f496e76616c696420434e2072657761726420616464726573732e000000000000604482015290519081900360640190fd5b82600160a060020a031663392e53cd6040518163ffffffff16600080516020614f43833981519152028152600401602060405180830381600087803b15801561139a57600080fd5b505af11580156113ae573d6000803e3d6000fd5b505050506040513d60208110156113c457600080fd5b5051151560011461141f576040805160e560020a62461bcd02815260206004820152601f60248201527f434e20636f6e7472616374206973206e6f7420696e697469616c697a65642e00604482015290519081900360640190fd5b5060098054600160a060020a03808616600081815260086020908152604080832086905560018087019097557f6e1540171b6c0c960b71a7020d9f60077f6af931a8bbf590da0223dacf75c7af8601805473ffffffffffffffffffffffffffffffffffffffff199081168617909155600a8054808a019091557fc65a7bb8d6351c1cf70c95a316cc6a92839c986682d98bc35f958f4883f9d2a80180548b88169083168117909155600b8054998a0181559094527f0175b7a638427703f0dbe7bb9bbf987a2551717b34e79f33b5b1008d1fa01db99097018054958916959097168517909655855192835282015280840191909152915190917fe01726557c1ea9f7286dca4bba890e96fea9041689db298806306cafa74c9e91919081900360600190a150505050565b600281565b600033611567600a600160a060020a0385168480613e65565b9150611580600a600160a060020a038516600080613f38565b61158982614583565b80156115b45750600160008381526003602052604090206006015460ff1660048111156115b257fe5b145b156115c2576115c28261459e565b505050565b600080600080336115da89898989613e65565b6000818152600360205260409020600501549095501515611645576040805160e560020a62461bcd02815260206004820152601060248201527f496e76616c696420726571756573742e00000000000000000000000000000000604482015290519081900360640190fd5b600160008681526003602052604090206006015460ff16600481111561166757fe5b146116bc576040805160e560020a62461bcd02815260206004820152601f60248201527f4d757374206265206174206e6f742d636f6e6669726d65642073746174652e00604482015290519081900360640190fd5b60008581526003602052604081206004015490945092508391505b82821015611bac5760008581526003602052604090206004018054839081106116fc57fe5b600091825260209091200154600160a060020a0316331415611ba157600085815260036020526040902060050154600194504262093a8090910110156118a857600085815260036020526040902060050154426212750090910110156117b75761176585614ccd565b60008581526003602081905260408220805460ff1916815560018101839055600281018390559081018290559061179f6004830182614dc7565b5060006005820155600601805460ff191690556117d4565b6000858152600360205260409020600601805460ff191660041790555b600085815260036020526040908190209051339187917f9f3ca7a04988021200a04e0775f46648683bffe7203608269a66c371befe5685918d918d918d918d91600401908086600a81111561182557fe5b60ff16815260208101869052604081018590526060810184905260a082820381016080830190815284549183018290529160c001908490801561189157602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311611873575b5050965050505050505060405180910390a3611b9c565b60001983018214611939576000858152600360205260409020600401805460001985019081106118d457fe5b6000918252602080832090910154878352600390915260409091206004018054600160a060020a03909216918490811061190a57fe5b9060005260206000200160006101000a815481600160a060020a030219169083600160a060020a031602179055505b60008581526003602052604090206004018054600019850190811061195a57fe5b60009182526020808320909101805473ffffffffffffffffffffffffffffffffffffffff191690558682526003905260409020600401546119a290600163ffffffff614cb616565b60008681526003602052604090206119bd9060040182614da3565b5060008581526003602081905260409182902080546001820154600283015493830154945133958b957f9c174b2536ba49e3478ca649dac74d9e9f71f70adf70f193e780eabbfcdc367c9560ff9095169490926004909101908086600a811115611a2357fe5b60ff16815260208101869052604081018590526060810184905260a082820381016080830190815284549183018290529160c0019084908015611a8f57602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311611a71575b5050965050505050505060405180910390a36000858152600360205260409020600401541515611b9c57611ac285614ccd565b60008581526003602081905260408220805460ff19168155600181018390556002810183905590810182905590611afc6004830182614dc7565b506000600582018190556006909101805460ff19169055858152600360208190526040918290208054600182015460028301549290930154935133948a947fbfda049a0206fd9c90ed4a3170f5bfaad83c323a16835dd68fea92faa247c2cd9460ff9094169390929091908085600a811115611b7457fe5b60ff168152602081019490945250604080840192909252606083015251908190036080019150a35b611bac565b6001909101906116d7565b831515611c03576040805160e560020a62461bcd02815260206004820152601d60248201527f4d73672e73656e64657220686173206e6f74207265717565737465642e000000604482015290519081900360640190fd5b505050505050505050565b600060606000806000611c2389898989613e65565b600081815260036020908152604091829020600581015460068201546004909201805485518186028101860190965280865295965086959094919360ff90931692859190830182828015611ca057602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311611c82575b50505050509250945094509450945050945094509450949050565b600481565b600c5460ff1681565b60408051808201909152600b81527f41646472657373426f6f6b000000000000000000000000000000000000000000602082015281565b6000808284600160a060020a031663444263466040518163ffffffff16600080516020614f43833981519152028152600401602060405180830381600087803b158015611d4c57600080fd5b505af1158015611d60573d6000803e3d6000fd5b505050506040513d6020811015611d7657600080fd5b505114611dcd576040805160e560020a62461bcd02815260206004820152601460248201527f496e76616c6964204b49522076657273696f6e2e000000000000000000000000604482015290519081900360640190fd5b505060068054600160a060020a0384811673ffffffffffffffffffffffffffffffffffffffff198316179092551660008115611e7a5781600160a060020a031663444263466040518163ffffffff16600080516020614f43833981519152028152600401602060405180830381600087803b158015611e4b57600080fd5b505af1158015611e5f573d6000803e3d6000fd5b505050506040513d6020811015611e7557600080fd5b505190505b60408051600160a060020a038085168252602082018490528616818301526060810185905290517ffdccdf242038c2d09605009fbb95e03f75cdbd106d0a9e52a1670be9553c88489181900360800190a150505050565b60045460005b81811015611f535760036000600483815481101515611ef257fe5b600091825260208083209091015483528201929092526040018120805460ff1916815560018101829055600281018290556003810182905590611f386004830182614dc7565b5060006005820155600601805460ff19169055600101611ed7565b611f5f60046000614dc7565b6040517f907527d30089abd16e30f06ddbbbc18480505176262f19bc16c1fbf9262f9c6b90600090a15050565b600c54610100900460ff1681565b600160a060020a0381166000818152600860205260409020546009805491929183908110611fc457fe5b600091825260209091200154600160a060020a03161461202e576040805160e560020a62461bcd02815260206004820152601360248201527f496e76616c696420434e206e6f64652049442e00000000000000000000000000604482015290519081900360640190fd5b600954600110612088576040805160e560020a62461bcd02815260206004820152601b60248201527f434e2073686f756c64206265206d6f7265207468616e206f6e652e0000000000604482015290519081900360640190fd5b60095460001901811015612227576009805460001981019081106120a857fe5b60009182526020909120015460098054600160a060020a0390921691839081106120ce57fe5b6000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055600954600a805490916000190190811061211a57fe5b600091825260209091200154600a8054600160a060020a03909216918390811061214057fe5b6000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055600954600b805490916000190190811061218c57fe5b600091825260209091200154600b8054600160a060020a0390921691839081106121b257fe5b60009182526020822001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0393909316929092179091556009805483926008929091600019810190811061220157fe5b6000918252602080832090910154600160a060020a031683528201929092526040019020555b600160a060020a03821660009081526008602052604081205560098054600019810190811061225257fe5b6000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff1916905560095461228c90600163ffffffff614cb616565b612297600982614da3565b50600a805460001981019081106122aa57fe5b6000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff19169055600a546122e490600163ffffffff614cb616565b6122ef600a82614da3565b50600b8054600019810190811061230257fe5b6000918252602090912001805473ffffffffffffffffffffffffffffffffffffffff19169055600b5461233c90600163ffffffff614cb616565b612347600b82614da3565b5060408051600160a060020a038416815290517fa30079721e55931e89e7cdb421712ad0fcc817e7cac8fe954aa7ed0d46b9c42d9181900360200190a15050565b603281565b600754600160a060020a031681565b60005481906123b290600163ffffffff614d8a16565b60018054600160a060020a0385166000818152600260205260408120805460ff1916851790558054938401815580527f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563909201805473ffffffffffffffffffffffffffffffffffffffff191690921790915561242c611ed1565b604051600160a060020a038516907fad6de4452a631e641cb59902236607946ce9272b9b981f2f80e8d129cb9084ba90600090a250505050565b600c54606090819081908190600090819060ff16151561249f57604080516000808252602082019081528183019092529450925061274a565b6009805490506003026002016040519080825280602002602001820160405280156124d4578160200160208202803883390190505b50935060098054905060030260020160405190808252806020026020018201604052801561250c578160200160208202803883390190505b506009549093509150600090505b8181101561268c576000848260030281518110151561253557fe5b60ff909216602092830290910190910152600980548290811061255457fe5b6000918252602090912001548351600160a060020a039091169084906003840290811061257d57fe5b600160a060020a03909216602092830290910190910152835160019085906003840283019081106125aa57fe5b60ff909216602092830290910190910152600a8054829081106125c957fe5b6000918252602090912001548351600160a060020a03909116908490600384026001019081106125f557fe5b600160a060020a039092166020928302909101909101528351600290859060038402830190811061262257fe5b60ff909216602092830290910190910152600b80548290811061264157fe5b6000918252602090912001548351600160a060020a039091169084906002600385020190811061266d57fe5b600160a060020a0390921660209283029091019091015260010161251a565b6003848360030281518110151561269f57fe5b60ff9092166020928302909101909101526005548351600160a060020a03909116908490600385029081106126d057fe5b600160a060020a0390921660209283029091019091015283516004908590600160038602019081106126fe57fe5b60ff9092166020928302909101909101526006548351600160a060020a039091169084906003850260010190811061273257fe5b600160a060020a039092166020928302909101909101525b509194909350915050565b600081565b606481565b60008083837388bb3838aa0a140acb73eeb3d4b25a8d3afd58d433146127cf576040805160e560020a62461bcd02815260206004820152600f60248201527f496e76616c69642073656e6465722e0000000000000000000000000000000000604482015290519081900360640190fd5b600c54610100900460ff161561282f576040805160e560020a62461bcd02815260206004820152601460248201527f416c726561647920636f6e73747275637465642e000000000000000000000000604482015290519081900360640190fd5b600c805460ff19169055859350600092505b83831015612956576002600088888681811061285957fe5b60209081029290920135600160a060020a03168352508101919091526040016000205460ff161580156128b1575086868481811061289357fe5b90506020020135600160a060020a0316600160a060020a0316600014155b1515612907576040805160e560020a62461bcd02815260206004820152601e60248201527f41646472657373206973206e756c6c206f72206e6f7420756e697175652e0000604482015290519081900360640190fd5b60016002600089898781811061291957fe5b60209081029290920135600160a060020a0316835250810191909152604001600020805460ff191691151591909117905560019290920191612841565b61296260008888614de8565b506001859055600c805461ff001916610100179055604080518082018252600b81527f41646472657373426f6f6b00000000000000000000000000000000000000000060208083019182528351938401899052606080855283519085015282517fc5caa942b8f8ea45a2e094d941dbba0ef9c0307f34c81ce78e71bfb128d6b25a946000938b939192839283019160808401918083838a5b83811015612a125781810151838201526020016129fa565b50505050905090810190601f168015612a3f5780820380516001836020036101000a031916815260200191505b508381038252858181548152602001915080548015612a8757602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311612a69575b50509550505050505060405180910390a150505050505050565b60008054829033908290612abc90600163ffffffff614cb616565b600154612ad66002600160a060020a038916600080613e65565b9550612aef6002600160a060020a038916600080613f38565b612af886614583565b8015612b235750600160008781526003602052604090206006015460ff166004811115612b2157fe5b145b15612b3157612b318661459e565b50505050505050565b60008181526003602081815260408084208054600182015460028301549583015460058401546006850154600490950180548751818a0281018a019098528088528a998a998a996060998b998a9960ff918216999098959790969095949190921692918591830182828015612bd857602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311612bba575b505050505092509650965096509650965096509650919395979092949650565b600a5460009081908180855b83831015612c4f57600a805433919085908110612c1d57fe5b600091825260209091200154600160a060020a03161415612c445760019550829450612c4f565b600190920191612c04565b851515612ca6576040805160e560020a62461bcd02815260206004820152601e60248201527f4d73672e73656e646572206973206e6f7420434e20636f6e74726163742e0000604482015290519081900360640190fd5b600b805486908110612cb457fe5b600091825260209091200154600b8054600160a060020a039092169350889187908110612cdd57fe5b9060005260206000200160006101000a815481600160a060020a030219169083600160a060020a031602179055507faa5c92ffd739bc0b8b117b671e7d713917ddb1440b436263a3ea106d70c6f05f600986815481101515612d3b57fe5b600091825260209091200154600b8054600160a060020a039092169185919089908110612d6457fe5b6000918252602091829020015460408051600160a060020a03958616815293851692840192909252929092168183015290519081900360600190a150505050505050565b60008054339083908190612dc390600163ffffffff614d8a16565b6001805490612dde90600160a060020a038916600080613e65565b9550612aef6001600160a060020a038916600080613f38565b600033612e076004838080613e65565b9150612e17600460008080613f38565b612e2082614583565b8015612e4b5750600160008381526003602052604090206006015460ff166004811115612e4957fe5b145b15612e5957612e598261459e565b5050565b62093a8081565b600082338385600160a060020a031663444263466040518163ffffffff16600080516020614f43833981519152028152600401602060405180830381600087803b158015612eb157600080fd5b505af1158015612ec5573d6000803e3d6000fd5b505050506040513d6020811015612edb57600080fd5b505114612f32576040805160e560020a62461bcd02815260206004820152601460248201527f496e76616c6964204b49522076657273696f6e2e000000000000000000000000604482015290519081900360640190fd5b612f496007600160a060020a038716866000613e65565b9250610f236007600160a060020a038716866000613f38565b6212750081565b6007805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a03838116919091179182905560408051929091168252517f508aacd44cfe23a34a8c2643ab08c3410cf5505632cfce58dcfa0efa2fd2ff37916020908290030190a150565b600381565b600160a060020a03811660008181526008602052604081205460098054919385923392908690811061300357fe5b600091825260209091200154600160a060020a03161461306d576040805160e560020a62461bcd02815260206004820152601360248201527f496e76616c696420434e206e6f64652049442e00000000000000000000000000604482015290519081900360640190fd5b6009546001106130c7576040805160e560020a62461bcd02815260206004820152601b60248201527f434e2073686f756c64206265206d6f7265207468616e206f6e652e0000000000604482015290519081900360640190fd5b6130de6009600160a060020a038716600080613e65565b9250610f236009600160a060020a038716600080613f38565b60015481565b600654600160a060020a031681565b600054600154829081141561316b576040805160e560020a62461bcd02815260206004820152601160248201527f53616d6520726571756972656d656e742e000000000000000000000000000000604482015290519081900360640190fd5b6001839055613178611ed1565b6040805184815290517f8951393946c27b45080aad111464c16c70f3d5e7d24b114a627334441961bf5f9181900360200190a1505050565b6000808284600160a060020a0316630f6100726040518163ffffffff16600080516020614f43833981519152028152600401602060405180830381600087803b1580156131fc57600080fd5b505af1158015613210573d6000803e3d6000fd5b505050506040513d602081101561322657600080fd5b50511461327d576040805160e560020a62461bcd02815260206004820152601460248201527f496e76616c696420506f432076657273696f6e2e000000000000000000000000604482015290519081900360640190fd5b505060058054600160a060020a0384811673ffffffffffffffffffffffffffffffffffffffff19831617909255166000811561332a5781600160a060020a0316630f6100726040518163ffffffff16600080516020614f43833981519152028152600401602060405180830381600087803b1580156132fb57600080fd5b505af115801561330f573d6000803e3d6000fd5b505050506040513d602081101561332557600080fd5b505190505b60408051600160a060020a038085168252602082018490528616818301526060810185905290517fd531725ac89042f190fd73adfdeff435e07500f1a92b4b87743f1bcf91acb3a79181900360800190a150505050565b6000838383336000600980549050111561342857600160a060020a0388166000818152600860205260409020546009805490919081106133bd57fe5b600091825260209091200154600160a060020a03161415613428576040805160e560020a62461bcd02815260206004820152601960248201527f434e206e6f646520494420616c72656164792065786973742e00000000000000604482015290519081900360640190fd5b87600160a060020a031687600160a060020a031663139d7fed6040518163ffffffff16600080516020614f43833981519152028152600401602060405180830381600087803b15801561347a57600080fd5b505af115801561348e573d6000803e3d6000fd5b505050506040513d60208110156134a457600080fd5b5051600160a060020a031614613504576040805160e560020a62461bcd02815260206004820152601360248201527f496e76616c696420434e206e6f64652049442e00000000000000000000000000604482015290519081900360640190fd5b85600160a060020a031687600160a060020a0316638cf57cb96040518163ffffffff16600080516020614f43833981519152028152600401602060405180830381600087803b15801561355657600080fd5b505af115801561356a573d6000803e3d6000fd5b505050506040513d602081101561358057600080fd5b5051600160a060020a0316146135e0576040805160e560020a62461bcd02815260206004820152601a60248201527f496e76616c696420434e2072657761726420616464726573732e000000000000604482015290519081900360640190fd5b86600160a060020a031663392e53cd6040518163ffffffff16600080516020614f43833981519152028152600401602060405180830381600087803b15801561362857600080fd5b505af115801561363c573d6000803e3d6000fd5b505050506040513d602081101561365257600080fd5b505115156001146136ad576040805160e560020a62461bcd02815260206004820152601f60248201527f434e20636f6e7472616374206973206e6f7420696e697469616c697a65642e00604482015290519081900360640190fd5b6136c96008600160a060020a03808b16908a8116908a16613e65565b94506136e76008600160a060020a03808b16908a8116908a16613f38565b6136f085614583565b801561371b5750600160008681526003602052604090206006015460ff16600481111561371957fe5b145b15613729576137298561459e565b5050505050505050565b600c5460ff161561378e576040805160e560020a62461bcd02815260206004820152601260248201527f416c7265616479206163746976617465642e0000000000000000000000000000604482015290519081900360640190fd5b60005415156137e7576040805160e560020a62461bcd02815260206004820152601360248201527f4e6f2061646d696e206973206c69737465642e00000000000000000000000000604482015290519081900360640190fd5b600554600160a060020a03161515613849576040805160e560020a62461bcd02815260206004820152601f60248201527f506f4320636f6e7472616374206973206e6f7420726567697374657265642e00604482015290519081900360640190fd5b600654600160a060020a031615156138ab576040805160e560020a62461bcd02815260206004820152601f60248201527f4b495220636f6e7472616374206973206e6f7420726567697374657265642e00604482015290519081900360640190fd5b6009541515613904576040805160e560020a62461bcd02815260206004820152601560248201527f4e6f206e6f6465204944206973206c69737465642e0000000000000000000000604482015290519081900360640190fd5b600a5460095414613985576040805160e560020a62461bcd02815260206004820152603660248201527f496e76616c6964206c656e677468206265747765656e206e6f6465204944732060448201527f616e64207374616b696e6720636f6e7472616374732e00000000000000000000606482015290519081900360840190fd5b600b54600a5414613a06576040805160e560020a62461bcd02815260206004820152603e60248201527f496e76616c6964206c656e677468206265747765656e207374616b696e67206360448201527f6f6e74726163747320616e6420726577617264206164647265737365732e0000606482015290519081900360840190fd5b600c805460ff191660011790556040517f29d89931226d613bf878a0be8c635eaf2049121c8c68d5ad80a78f0ac9005d4b90600090a1565b600554600160a060020a031681565b60606004805480602002602001604051908101604052809291908181526020018280548015613a9c57602002820191906000526020600020905b81548152600190910190602001808311613a87575b505050505090505b90565b600181565b600080546001543391908490811415613b0f576040805160e560020a62461bcd02815260206004820152601160248201527f53616d6520726571756972656d656e742e000000000000000000000000000000604482015290519081900360640190fd5b613b1d600386600080613e65565b9350613b2d600386600080613f38565b613b3684614583565b8015613b615750600160008581526003602052604090206006015460ff166004811115613b5f57fe5b145b15610f6557610f658461459e565b600c54600090339060ff1615613bcf576040805160e560020a62461bcd02815260206004820152601260248201527f416c7265616479206163746976617465642e0000000000000000000000000000604482015290519081900360640190fd5b6000541515613c28576040805160e560020a62461bcd02815260206004820152601360248201527f4e6f2061646d696e206973206c69737465642e00000000000000000000000000604482015290519081900360640190fd5b600554600160a060020a03161515613c8a576040805160e560020a62461bcd02815260206004820152601f60248201527f506f4320636f6e7472616374206973206e6f7420726567697374657265642e00604482015290519081900360640190fd5b600654600160a060020a03161515613cec576040805160e560020a62461bcd02815260206004820152601f60248201527f4b495220636f6e7472616374206973206e6f7420726567697374657265642e00604482015290519081900360640190fd5b6009541515613d45576040805160e560020a62461bcd02815260206004820152601560248201527f4e6f206e6f6465204944206973206c69737465642e0000000000000000000000604482015290519081900360640190fd5b600a5460095414613dc6576040805160e560020a62461bcd02815260206004820152603660248201527f496e76616c6964206c656e677468206265747765656e206e6f6465204944732060448201527f616e64207374616b696e6720636f6e7472616374732e00000000000000000000606482015290519081900360840190fd5b600b54600a5414613e47576040805160e560020a62461bcd02815260206004820152603e60248201527f496e76616c6964206c656e677468206265747765656e207374616b696e67206360448201527f6f6e74726163747320616e6420726577617264206164647265737365732e0000606482015290519081900360840190fd5b613e55600560008080613e65565b9150612e17600560008080613f38565b6000848484846040516020018085600a811115613e7e57fe5b60ff167f010000000000000000000000000000000000000000000000000000000000000002815260018101949094525060218301919091526041808301919091526040805180840390920182526061909201918290528051909250819060208401908083835b60208310613f035780518252601f199092019160209182019101613ee4565b5181516020939093036101000a6000190180199091169216919091179052604051920182900390912098975050505050505050565b6000806000613f4987878787613e65565b600081815260036020526040902060050154909350156142df5760008381526003602052604090206005015442621275009091011015613fde57613f8c83614ccd565b60008381526003602081905260408220805460ff19168155600181018390556002810183905590810182905590613fc66004830182614dc7565b5060006005820155600601805460ff191690556142df565b6000838152600360205260409020600501544262093a80909101101561411657600460008481526003602052604090206006015460ff16600481111561402057fe5b14614042576000838152600360205260409020600601805460ff191660041790555b600083815260036020526040908190209051339185917f9f3ca7a04988021200a04e0775f46648683bffe7203608269a66c371befe5685918b918b918b918b91600401908086600a81111561409357fe5b60ff16815260208101869052604081018590526060810184905260a082820381016080830190815284549183018290529160c00190849080156140ff57602002820191906000526020600020905b8154600160a060020a031681526001909101906020018083116140e1575b5050965050505050505060405180910390a36142df565b60008381526003602052604090206005015442106142df575050600081815260036020526040812060040154905b818110156141dd57600083815260036020526040902060040180548290811061416957fe5b600091825260209091200154600160a060020a03163314156141d5576040805160e560020a62461bcd02815260206004820152601d60248201527f4d73672e73656e64657220616c7265616479207265717565737465642e000000604482015290519081900360640190fd5b600101614144565b60008381526003602090815260408083206004018054600181018255818552928420909201805473ffffffffffffffffffffffffffffffffffffffff191633908117909155928690525185917fb7b03afe355fcf2b1d00e020db2b1a902b9ee1b1c1d995626c1e18c957340ea8918b918b918b918b918086600a81111561426057fe5b60ff16815260208101869052604081018590526060810184905260a082820381016080830190815284549183018290529160c00190849080156142cc57602002820191906000526020600020905b8154600160a060020a031681526001909101906020018083116142ae575b5050965050505050505060405180910390a35b6000838152600360205260409020600501541515612b315760045460641161436457600487600a81111561430f57fe5b14614364576040805160e560020a62461bcd02815260206004820152601560248201527f52657175657374206c6973742069732066756c6c2e0000000000000000000000604482015290519081900360640190fd5b60e06040519081016040528088600a81111561437c57fe5b81526020808201899052604080830189905260608301889052805160008082529281019091526080909201919050815242602082015260400160019052600084815260036020526040902081518154829060ff1916600183600a8111156143df57fe5b0217905550602082810151600183015560408301516002830155606083015160038301556080830151805161441a9260048501920190614e58565b5060a0820151600582015560c082015160068201805460ff1916600183600481111561444257fe5b021790555050506000838152600360209081526040808320600490810180546001818101835582875294862001805473ffffffffffffffffffffffffffffffffffffffff19163390811790915582549485019092557f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b909301879055928690525185917fb7b03afe355fcf2b1d00e020db2b1a902b9ee1b1c1d995626c1e18c957340ea8918b918b918b918b918086600a8111156144fc57fe5b60ff16815260208101869052604081018590526060810184905260a082820381016080830190815284549183018290529160c001908490801561456857602002820191906000526020600020905b8154600160a060020a0316815260019091019060200180831161454a575b5050965050505050505060405180910390a350505050505050565b60015460009182526003602052604090912060040154101590565b60006145a8614eba565b600083815260036020526040808220815160e0810190925280549294509091829060ff16600a8111156145d757fe5b600a8111156145e257fe5b81526001820154602080830191909152600283015460408084019190915260038401546060840152600484018054825181850281018501909352808352608090940193919290919083018282801561466357602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311614645575b505050918352505060058201546020820152600682015460409091019060ff16600481111561468e57fe5b600481111561469957fe5b905250905060018151600a8111156146ad57fe5b1415614717576020810151604080517f70480275000000000000000000000000000000000000000000000000000000008152600160a060020a0390921660048301525130916370480275916024808301926000929190829003018183875af1925050509150614b3c565b60028151600a81111561472657fe5b1415614790576020810151604080517f27e1f7df000000000000000000000000000000000000000000000000000000008152600160a060020a0390921660048301525130916327e1f7df916024808301926000929190829003018183875af1925050509150614b3c565b60038151600a81111561479f57fe5b1415614801576020810151604080517fc47afb3a000000000000000000000000000000000000000000000000000000008152600481019290925251309163c47afb3a916024808301926000929190829003018183875af1925050509150614b3c565b60048151600a81111561481057fe5b141561485d5730600160a060020a0316634f97638f6040518163ffffffff16600080516020614f438339815191520281526004016000604051808303816000875af1925050509150614b3c565b60058151600a81111561486c57fe5b14156148b95730600160a060020a031663cec924666040518163ffffffff16600080516020614f438339815191520281526004016000604051808303816000875af1925050509150614b3c565b60068151600a8111156148c857fe5b141561493b57602081015160408083015181517fc7e9de75000000000000000000000000000000000000000000000000000000008152600160a060020a039093166004840152602483015251309163c7e9de75916044808301926000929190829003018183875af1925050509150614b3c565b60078151600a81111561494a57fe5b14156149bd57602081015160408083015181517f4c5d435c000000000000000000000000000000000000000000000000000000008152600160a060020a0390931660048401526024830152513091634c5d435c916044808301926000929190829003018183875af1925050509150614b3c565b60088151600a8111156149cc57fe5b1415614a4f576020810151604080830151606084015182517f298b3c61000000000000000000000000000000000000000000000000000000008152600160a060020a0394851660048201529184166024830152909216604483015251309163298b3c61916064808301926000929190829003018183875af1925050509150614b3c565b60098151600a811115614a5e57fe5b1415614ac8576020810151604080517f579740db000000000000000000000000000000000000000000000000000000008152600160a060020a03909216600483015251309163579740db916024808301926000929190829003018183875af1925050509150614b3c565b600a8151600a811115614ad757fe5b1415614b3c576020810151604080517fafaaf330000000000000000000000000000000000000000000000000000000008152600160a060020a03909216600483015251309163afaaf330916024808301926000929190829003018183875af194505050505b614b4583614ccd565b8115614bff5760008381526003602052604090206005015415614b7f576000838152600360205260409020600601805460ff191660021790555b33600160a060020a031683600019167fc55c9229184beabeee72b6970a96691b4200919e47579cc4b9be50a1bec7ef1183600001518460200151856040015186606001516040518085600a811115614bd357fe5b60ff168152602081019490945250604080840192909252606083015251908190036080019150a36115c2565b60008381526003602052604090206005015415614c36576000838152600360208190526040909120600601805460ff191690911790555b33600160a060020a031683600019167ff151a3ee41626c2511372320f09f7957af81c8c1cde8cdf3f05a5979626eaaf383600001518460200151856040015186606001516040518085600a811115614c8a57fe5b60ff168152602081019490945250604080840192909252606083015251908190036080019150a3505050565b60008083831115614cc657600080fd5b5050900390565b60045460005b818110156115c2576004805482908110614ce957fe5b600091825260209091200154831415614d825760001982018114614d4057600480546000198401908110614d1957fe5b9060005260206000200154600482815481101515614d3357fe5b6000918252602090912001555b600480546000198401908110614d5257fe5b6000918252602082200155600454614d7190600163ffffffff614cb616565b614d7c600482614da3565b506115c2565b600101614cd3565b600082820183811015614d9c57600080fd5b9392505050565b8154818355818111156115c2576000838152602090206115c2918101908301614ef7565b5080546000825590600052602060002090810190614de59190614ef7565b50565b828054828255906000526020600020908101928215614e48579160200282015b82811115614e4857815473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a03843516178255602090920191600190910190614e08565b50614e54929150614f11565b5090565b828054828255906000526020600020908101928215614e48579160200282015b82811115614e48578251825473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a03909116178255602090920191600190910190614e78565b6040805160e081019091528060008152600060208201819052604082018190526060808301829052608083015260a0820181905260c09091015290565b613aa491905b80821115614e545760008155600101614efd565b613aa491905b80821115614e5457805473ffffffffffffffffffffffffffffffffffffffff19168155600101614f1756000000000100000000000000000000000000000000000000000000000000000000a165627a7a72305820745a4ec646af79ff75bd0e961f9203eb9255767e53a82de3a972d31c3bd0d6760029")

func prepareSimulatedContract(t *testing.T) ([]*bind.TransactOpts, *backends.SimulatedBackend, common.Address, *govcontract.GovParam) {
	// Create accounts and simulated blockchain
	accounts := []*bind.TransactOpts{}
	alloc := blockchain.GenesisAlloc{
		abookAddr: blockchain.GenesisAccount{
			Code:    abookOverride,
			Balance: big.NewInt(0),
		},
	}
	for i := 0; i < 1; i++ {
		key, _ := crypto.GenerateKey()
		account := bind.NewKeyedTransactor(key)
		account.GasLimit = 10000000
		accounts = append(accounts, account)
		alloc[account.From] = blockchain.GenesisAccount{Balance: big.NewInt(params.KLAY)}
	}
	sim := backends.NewSimulatedBackend(alloc)

	// Deploy contract
	owner := accounts[0]
	address, _, contract, err := govcontract.DeployGovParam(owner, sim)
	require.Nil(t, err)
	sim.Commit()

	tx, err := contract.Initialize(owner, owner.From)
	require.Nil(t, err)
	sim.Commit()

	receipt, _ := sim.TransactionReceipt(nil, tx.Hash())
	require.NotNil(t, receipt)
	require.Equal(t, types.ReceiptStatusSuccessful, receipt.Status)

	return accounts, sim, address, contract
}

func prepareSimulatedContractWithParams(t *testing.T, p map[string][]byte) ([]*bind.TransactOpts, *backends.SimulatedBackend, common.Address, *govcontract.GovParam) {
	accounts, sim, address, contract := prepareSimulatedContract(t)

	// Empty array before addParam()
	names, values, err := contract.GetAllParams(nil)
	require.Nil(t, err)
	require.Equal(t, 0, len(names))
	require.Equal(t, 0, len(values))

	// Call addParam()
	owner := accounts[0]
	txs := make(types.Transactions, 0)
	for k, v := range p {
		tx, err := contract.AddParam(owner, k, v)
		require.Nil(t, err)
		txs = append(txs, tx)
	}

	sim.Commit() // mine addParam
	sim.Commit() // mine activation block so getParam returns added param

	for _, tx := range txs {
		receipt, _ := sim.TransactionReceipt(nil, tx.Hash())
		require.NotNil(t, receipt)
		require.Equal(t, types.ReceiptStatusSuccessful, receipt.Status)
	}

	// Value exists after addParam
	for k, v := range p {
		value, err := contract.GetParam(nil, k)
		require.Nil(t, err)
		require.Equal(t, v, value)
	}

	return accounts, sim, address, contract
}

func prepareRegistry(t *testing.T, owner *bind.TransactOpts, sim *backends.SimulatedBackend, gpAddr common.Address) (common.Address, *regcontract.Registry) {
	// (1) deploy Registry.sol
	regAddr, _, reg, err := regcontract.DeployRegistry(owner, sim)
	require.Nil(t, err)
	sim.Commit()

	// (2) register govparam in registry
	tx, err := reg.SetAddress(owner, GOVPARAM_NAME, gpAddr)
	require.Nil(t, err)
	sim.Commit()

	receipt, _ := sim.TransactionReceipt(nil, tx.Hash())
	require.NotNil(t, receipt)
	require.Equal(t, types.ReceiptStatusSuccessful, receipt.Status)

	// (3) set spare contract address in address book
	abook, err := contract.NewAddressBook(abookAddr, sim)
	require.Nil(t, err)
	tx, err = abook.UpdateSpareContract(owner, regAddr)
	require.Nil(t, err)
	sim.Commit()

	receipt, _ = sim.TransactionReceipt(nil, tx.Hash())
	require.NotNil(t, receipt)
	require.Equal(t, types.ReceiptStatusSuccessful, receipt.Status)

	result, err := abook.SpareContractAddress(nil)
	require.Nil(t, err)
	require.Equal(t, regAddr, result)

	return regAddr, reg
}

func prepareContractEngine(t *testing.T, bc *blockchain.BlockChain, addr common.Address) *ContractEngine {
	config := params.CypressChainConfig.Copy()
	config.ContractGovCompatibleBlock = big.NewInt(0)

	e := NewContractEngine(config)
	e.SetBlockchain(bc)
	err := e.UpdateParams()
	require.Nil(t, err)

	return e
}

func TestContractEngine_Params(t *testing.T) {
	initialParam := map[string][]byte{
		"istanbul.committeesize": {0xa},
		"governance.unitprice":   {0xb},
	}
	accounts, sim, addr, contract := prepareSimulatedContractWithParams(t, initialParam)
	owner := accounts[0]
	prepareRegistry(t, owner, sim, addr)
	e := prepareContractEngine(t, sim.BlockChain(), addr)

	//     start          setparam       activation         end
	// Block |---------------|---------------|---------------|
	//               ^               ^               ^
	//               t0              t1              t2
	// At num = activation - 1, Params() = prev
	// At num = activation, Params() = next
	var (
		start      = sim.BlockChain().CurrentHeader().Number.Uint64()
		setparam   = start + 5
		activation = setparam + 5
		end        = activation + 5
		key        = "governance.unitprice"
		val        = []byte{0xff, 0xff, 0xff, 0xff}
		update, _  = params.NewGovParamSetBytesMap(map[string][]byte{
			key: val,
		})
		psetPrev, _ = params.NewGovParamSetBytesMap(initialParam)   // for t0 & t1
		psetNext    = params.NewGovParamSetMerged(psetPrev, update) // for t2
	)

	for num := start; num < end; num++ {
		if num == setparam { // setParam
			contract.SetParam(owner, key, val, activation)
		}

		var expected *params.GovParamSet

		if num < activation { // t0 & t1
			expected = psetPrev
		} else { // t2
			expected = psetNext
		}

		require.Equal(t, expected, e.Params())
		sim.Commit()
		err := e.UpdateParams()
		require.Nil(t, err)
	}
}

func TestContractEngine_ParamsAt(t *testing.T) {
	initialParam := map[string][]byte{
		"istanbul.committeesize": {0xa},
		"governance.unitprice":   {0xbb, 0xbb, 0xbb, 0xbb},
	}
	accounts, sim, addr, contract := prepareSimulatedContractWithParams(t, initialParam)
	owner := accounts[0]
	prepareRegistry(t, owner, sim, addr)
	e := prepareContractEngine(t, sim.BlockChain(), addr)

	//     start          setparam       activation         end
	// Block |---------------|---------------|---------------|
	//               ^               ^               ^
	//               t0              t1              t2
	// ParamsAt(activation) = prev
	// ParamsAt(activation + 1) = next
	var (
		start      = sim.BlockChain().CurrentHeader().Number.Uint64()
		setparam   = start + 5
		activation = setparam + 5
		end        = activation + 5
		key        = "governance.unitprice"
		val        = []byte{0xff, 0xff, 0xff, 0xff}
		update, _  = params.NewGovParamSetBytesMap(map[string][]byte{
			key: val,
		})
		psetPrev, _ = params.NewGovParamSetBytesMap(initialParam)   // for t0 & t1
		psetNext    = params.NewGovParamSetMerged(psetPrev, update) // for t2
	)

	for num := start; num < end; num++ {
		if num == setparam { // setParam
			contract.SetParam(owner, key, val, activation)
		}

		for iter := start + 1; iter <= num; iter++ {
			var expected *params.GovParamSet

			if iter < activation { // t0 & t1
				expected = psetPrev
			} else { // t2
				expected = psetNext
			}

			result, _ := e.ParamsAt(iter + 1)
			require.Equal(t, expected, result)
		}

		sim.Commit()
		err := e.UpdateParams()
		require.Nil(t, err)
	}
}
